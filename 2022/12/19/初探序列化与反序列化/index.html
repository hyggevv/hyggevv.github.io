<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.7.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.7.0" type="image/png" sizes="32x32"><meta name="description" content="在buu进行学习做到关于序列化和反序列化的题目；感觉十分的手足无措；所以来记录一下序列化和反序列的学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="初识序列化与反序列化">
<meta property="og:url" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="hey&#39;s blog">
<meta property="og:description" content="在buu进行学习做到关于序列化和反序列化的题目；感觉十分的手足无措；所以来记录一下序列化和反序列的学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/15.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/16.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/17.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/18.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/19.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/21.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/22.png">
<meta property="og:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/23.png">
<meta property="article:published_time" content="2022-12-19T07:56:15.000Z">
<meta property="article:modified_time" content="2023-04-25T15:14:11.437Z">
<meta property="article:author" content="hey">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png"><title>初识序列化与反序列化 | hey's blog</title><link ref="canonical" href="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.7.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">About</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/read/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">menu.read</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">hey's blog</div><div class="header-banner-info__subtitle">天气转晴太阳崭新我在前进</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">初识序列化与反序列化</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-12-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-04-25</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">Visited</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p>在buu进行学习时做到[极客大挑战 2019]PHP感觉十分的陌生且不知所措；所以还是学习记录一下<br>序列化：php程序为了保存和转储对象，提供了序列化的方法，php序列化是为了在程序运行的过程中对对象进行转储而产生的。序列化可以将对象转换成字符串，但仅保留对象里的成员变量，不保留函数方法。<br>举个例子：<br>比如：现在我们都会在淘宝上买桌子，桌子这种很不规则的东西，该怎么从一个城市运输到另一个城市，这时候一般都会把它拆掉成板子，再装到箱子里面，就可以快递寄出去了，这个过程就类似我们的序列化的过程（把数据转化为可以存储或者传输的形式）。当买家收到货后，就需要自己把这些板子组装成桌子的样子，这个过程就像反序列的过程（转化成当初的数据对象）。也就是说，序列化的目的是方便数据的传输和存储。<br>php序列化的函数为serialize。反序列化的函数为unserialize。<br>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png"><br>上述代码定义了一个people类，并在在类中定义了一个public类型的变量$name和类方法smile。然后实例化一个对象$psycho，去调用people类里面的smile方法，打印出结果。</p>

        <h2 id="序列化：">
          <a href="#序列化：" class="heading-link"><i class="fas fa-link"></i></a><a href="#序列化：" class="headerlink" title="序列化："></a>序列化：</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line"></span><br><span class="line">         public$a = &#x27;ThisA&#x27;;</span><br><span class="line"></span><br><span class="line">         protected$b = &#x27;ThisB&#x27;;</span><br><span class="line"></span><br><span class="line">         private$c = &#x27;ThisC&#x27;;</span><br><span class="line"></span><br><span class="line">         publicfunction test1()&#123;</span><br><span class="line"></span><br><span class="line">                  return&#x27;this is test1 &#x27;;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test = new Test();</span><br><span class="line"></span><br><span class="line">var_dump(serialize($test));</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png"><br>此时的O代表对象；4代表改对象的名称有4个字符；3代表改对象里面有三个元素（我们这个类的三个成员变量由于变量前的修饰不同，在序列化出来后显示的也不同)<br>第一个变量a序列化后为 s:1:”a”;s:5:”ThisA”;此时的s:1代表着这个名称的字符个数(与我们定义的类型有关)<br>“a”代表该字符串为a；后面同理。<br>O:对象名的长度:”对象名”:对象属性个数:{s:属性名的长度:”属性名”;s:属性值的长度:”属性值”;}<br>类型                  结构<br>String           s:size:value;<br>Integer          i:value;<br>Boolean          b:value;(保存1或0)<br>Null             N;<br>Array            a:size:{key definition;value definition;(repeated per element)}<br>Object           O:strlen(object name):object name:object size:{s:strlen(property<br>                 name):property name:property definition;(repeated per property)}<br>(注意类里面的方法并不会序列化。)<br>注意：当访问控制修饰符(public、protected、private)不同时，序列化后的结果也不同，当我们做题的时候需要注意这一点，%00 虽然不会显示，但是提交还是要加上去。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public : 被序列化的时候属性名 不会更改</span><br><span class="line">protected : 被序列化的时候属性名 会变成 %00*%00属性名</span><br><span class="line">private : 被序列化的时候属性名 会变成 %00类名%00属性名</span><br></pre></td></tr></table></div></figure>


        <h2 id="反序列化：">
          <a href="#反序列化：" class="heading-link"><i class="fas fa-link"></i></a><a href="#反序列化：" class="headerlink" title="反序列化："></a>反序列化：</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line"></span><br><span class="line">         public$a = &#x27;ThisA&#x27;;</span><br><span class="line"></span><br><span class="line">         protected$b = &#x27;ThisB&#x27;;</span><br><span class="line"></span><br><span class="line">         private$c = &#x27;ThisC&#x27;;</span><br><span class="line"></span><br><span class="line">         publicfunction test1()&#123;</span><br><span class="line"></span><br><span class="line">                  return&#x27;this is test1 &#x27;;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test = new Test();</span><br><span class="line"></span><br><span class="line">$sTest = serialize($test);</span><br><span class="line"></span><br><span class="line">$usTest = unserialize($sTest);</span><br><span class="line"></span><br><span class="line">var_dump($usTest);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"><br>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果让攻击者操纵任意反序列数据， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>

        <h2 id="相关的魔术方法">
          <a href="#相关的魔术方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关的魔术方法" class="headerlink" title="相关的魔术方法:"></a>相关的魔术方法:</h2>
      <p>1.__consruct()和__destruct()</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__construct ( mixed ...$values = &quot;&quot; ) : void</span><br></pre></td></tr></table></div></figure>
<p>PHP 允许开发者在一个类中定义一个方法作为构造函数。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct ( ) : void</span><br></pre></td></tr></table></div></figure>
<p>析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png"><br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png"><br>2.__sleep()和 __wakeup()</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public __sleep ( ) : array</span><br><span class="line">public __wakeup ( ) : void</span><br><span class="line">serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。与之相反，unserialize()会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup() 方法，预先准备对象需要的资源。</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png"><br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png"><br>3.__toString()</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public __toString ( ) : string</span><br><span class="line">__toString()方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。此方法必须返回一个字符串，否则将发出一条 E_RECOVERABLE_ERROR 级别的致命错误。</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png"><br>触发方式：<br>echo ($obj) &#x2F; print($obj) 打印时会触发<br>反序列化对象与字符串连接时<br>反序列化对象参与格式化字符串时<br>反序列化对象与字符串进行比较时（PHP进行比较的时候会转换参数类型）<br>反序列化对象参与格式化SQL语句，绑定参数时<br>反序列化对象在经过php字符串函数，如 strlen()、addslashes()时<br>在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有toString返回的字符串的时候toString会被调用<br>反序列化的对象作为 class_exists() 的参数的时候</p>

        <h2 id="4-属性重载">
          <a href="#4-属性重载" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-属性重载" class="headerlink" title="4.属性重载"></a>4.属性重载</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public __set ( string $name , mixed $value ) : void  在给不可访问属性赋值时，__set()会被调用。</span><br><span class="line">public __get ( string $name ) : mixed  读取不可访问属性的值时，__get() 会被调用。</span><br><span class="line">public __isset ( string $name ) : bool  当对不可访问属性调用 isset()或 empty() 时，__isset() 会被调用。</span><br><span class="line">public __unset ( string $name ) : void     当对不可访问属性调用 unset() 时，__unset() 会被调用。</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png"><br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png"><br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png"><br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png"></p>
<p>5.__call()</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public __call ( string $name , array $arguments ) : mixed</span><br></pre></td></tr></table></div></figure>
<p>在对象中调用一个不可访问方法时,调用该函数。<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png"><br>6.__invoke()</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__invoke ( $... = ? ) : mixed</span><br><span class="line">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/15.png"><br>对象被创建时执行__construct。<br>使用serialize()序列化对象。先执行__sleep，再序列化。<br>unserialize( )会检查是否存在一个_wakeup( )方法。如果存在，则会先调用_wakeup()方法，预先准备对象需要的资源。<br>把对象当做字符串使用，比如将对象与字符串进行拼接，或者使用echo输出对象，会执行__toString<br>程序运行完毕，对象自动销毁，执行__destruct。<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png"><br>下面这篇文章很好对魔术方法介绍得很到位：<br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000007250604">https://segmentfault.com/a/1190000007250604</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="反序列化漏洞">
          <a href="#反序列化漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2>
      <p>反序列化漏洞的成因在于代码中的 unserialize() 接收的参数可控,这个函数的参数是一个序列化的对象，而序列化的对象只含有对象的属性，那我们就要利用对对象属性的篡改实现最终的攻击。</p>

        <h2 id="魔法方法的作用">
          <a href="#魔法方法的作用" class="heading-link"><i class="fas fa-link"></i></a><a href="#魔法方法的作用" class="headerlink" title="魔法方法的作用"></a>魔法方法的作用</h2>
      <p>从上面的序列化和反序列化的知识我们可以知道，对象的序列化和反序列化只能是里面的属性，也就是说我们通过篡改反序列化的字符串只能获取或控制其他类的属性，这样一来利用面就很窄，因为属性的值都是已经预先设置好的，如果我们想利用类里面的方法呢？这时候魔术方法就派上用场了，魔术正如上面介绍的，魔术方法的调用是在该类序列化或者反序列化的同时自动完成的，不需要人工干预，这就非常符合我们的想法，因此只要魔法方法中出现了一些我们能利用的函数，我们就能通过反序列化中对其对象属性的操控来实现对这些函数的操控，进而达到我们发动攻击的目的。 </p>

        <h2 id="魔法方法的简单利用">
          <a href="#魔法方法的简单利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#魔法方法的简单利用" class="headerlink" title="魔法方法的简单利用"></a>魔法方法的简单利用</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class demo &#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test = new L();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        $this-&gt;test-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class L &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;function action() in class L&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Evil &#123;</span><br><span class="line">    var $test2;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        eval($this-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">unserialize($_GET[&#x27;test&#x27;]);</span><br></pre></td></tr></table></div></figure>
<p>首先我们能看到unserialize()函数的参数我们是可以控制的，也就是说我们能通过这个接口反序列化任何类的对象(但只有在当前作用域的类才对我们有用)，那我们看一下当前这三个类，我们看到后面两个类反序列化以后对我们没有任何意义，因为我们根本没法调用其中的方法，但是第一个类就不一样了，虽然我们也没有什么代码能实现调用其中的方法的，但是我们发现他有一个魔法函数__destruct() ，这就非常有趣了，因为这个函数能在对象销毁的时候自动调用，不用我们人工的干预，接下来让我们看一下怎么利用。<br>我们看到__destruct()里面只用到了一个属性test，再观察一下哪些地方调用了action()函数，看看这个函数的调用中有没有存在执行命令或者是其他我们能利用的点的，果然在 Evil 这个类中发现他的 action()函数调用了eval(),那我们的想法就很明确了，只需要将demo这个类中的test属性篡改为Evil这个类的对象，然后为了eval 能执行命令，我们还要篡改Evil对象的test2属性，将其改成要执行的命令。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class demo &#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;test = new Evil();                     //这里将 L 换成 Evil</span><br><span class="line">        $this-&gt;test-&gt;test2 = &quot;phpinfo();&quot;;            //初始化对象 $test2 值</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        $this-&gt;test-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Evil &#123;</span><br><span class="line">    var $test2;</span><br><span class="line">    function action()&#123;</span><br><span class="line">        eval($this-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$demo = new demo();</span><br><span class="line">$data = serialize($demo);</span><br><span class="line">var_dump($data);</span><br></pre></td></tr></table></div></figure>
<p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/16.png"></p>

        <h2 id="攻击流程">
          <a href="#攻击流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h2>
      <p>寻找unserialize()函数的参数是否有我们的可控点；<br>寻找我们的反序列化的目标，重点寻找存在 wakeup() 或 destruct() 魔法函数的类；<br>一层一层地研究该类在魔法方法中使用的属性和属性调用的方法，看看是否有可控的属性能实现在当前调用的过程中触发的；<br>找到我们要控制的属性了以后我们就将要用到的代码部分复制下来，然后构造序列化，发起攻击。</p>

        <h2 id="极客大挑战-2019-PHP">
          <a href="#极客大挑战-2019-PHP" class="heading-link"><i class="fas fa-link"></i></a><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h2>
      <p>学习了序列化和反序列化的基础知识之后；继续尝试这一题；这一题是需要先扫描后台然后得到后台备份文件(我用dirsearch扫描了好久才出来，后面用御剑进行扫描时却会出不来，还是需要有一本好字典啊)<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/17.png"><br>接下来得到了几个备份文件(里面还有一个假的flag这个是一眼假，之前在做nssctf里面有个假的flag那个真的<br>是个小可爱了)<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/18.png"><br>这里发现一个反序列化，然后反序列化里面的变量又是通过GET的方式提交的，所以人为可控<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/19.png"><br>接着看一下这个魔术方法：当我们提交的password&#x3D;100的时候和当我们提交的username&#x3D;admin时就可以得到flag。那此时我们需要想一下在什么时候后台会自动执行这个__destruct()魔术方法呢？那便是当序列化被反序列时会自动调用这个魔术方法；所以我们此时需要做的就是构造一个符合条件的序列化然后当这个序列化进行反序列化的时候便可以自动执行上图的魔术方法；帮我们把flag输出出来。<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20.png"><br>我们在继续看另外这个魔术方法，我们要想到当序列化执行反序列化的时候还会自动执行__wakeup()；而此时的<br>这个__wakeup()又会帮助我们将我们输入的username进行覆盖，覆盖成guest这就导致我们的payload无法匹配<br>下面的条件；那么此时我们需要进行一个绕过__wakeup()<br>注意：当成员属性数目大于实际数目时可绕过wakeup方法<br>O:对象名的长度:”对象名”:对象属性个数:{s:属性名的长度:”属性名”;s:属性值的长度:”属性值”;}<br>所以我们进行构造序列化时可以通过使对象属性个数大于真正个数时进行绕过(如本题是有两个对象，那么当我<br>们构造时可以令这个对象属性个数&gt;2进行绕过)<br>payload:?select&#x3D;O:4:”Name”:3:{s:14:”%00Name%00username”;s:5:”admin”;s:14:”%00Name%00password”;s:3:”100”;}</p>

        <h2 id="SWPUCTF-2021-新生赛-ez-unserialize">
          <a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-ez-unserialize" class="headerlink" title="[SWPUCTF 2021 新生赛]ez_unserialize"></a>[SWPUCTF 2021 新生赛]ez_unserialize</h2>
      <p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/21.png"><br>这里学习一下robots协议：robots是告诉搜索引擎，你可以爬取收录我的什么页面，你不可以爬取和收录我的那些页面。robots很好的控制网站那些页面可以被爬取，那些页面不可以被爬取。<br>1.user-agent这句代码表示那个搜索引擎准守协议。user-agent后面为搜索机器人名称，如果是“<em>”号，则泛指所有的搜索引擎机器人；</em>号表示所有。<br>2.Disallow是禁止爬取的意思。Disallow后面是不允许访问文件目录（你可以理解为路径中包含改字符、都不会爬取）。案例中显示“Disallow: &#x2F;?s* ” 表示路径中带有“&#x2F;?s”的路径都不能爬取。 * 代表匹配所有。 这里需要主机。 Disallow空格一个，&#x2F;必须为开头。<br>如果“Disallow: &#x2F;” 因为所有路径都包含&#x2F; ，所以这表示禁止爬取网站所有内容<br>所以当此题中出现User-agent：和Disallow:我们便想到了robots协议；所以在url后面加上robots.txt;此时禁止爬取的内容便显示出来了；接着我们访问改内容，发现是一道PHP反序列化<br><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/22.png"><br>然后我们发现$p是由GET提交的，人为可控；接下来看一下魔术方法，阅读函数发现当我们提交的admin&#x3D;admin且passwd&#x3D;ctf时便可以输出flag;而此时的__construct()魔术方法虽然赋给admin和passwd值；但是不影响；因<br>为__construct()的触发条件是当引用一个新变量的时候猜自动执行；而我们的__destruct()的执行是在序列化<br>转成反序列化的时候会自动执行；所以此题的突破点就在这里。<br>payload:?p&#x3D;O:4:”wllm”:2:{s:5:”admin”;s:5:”admin”;s:6:”passwd”;s:3:”ctf”;}<br>这一题并不存在什么过滤比[极客大挑战 2019]PHP简单一点；<br>[SWPUCTF 2021 新生赛]no_wakeup和[极客大挑战 2019]PHP的考点一模一样，这里就不多说了。</p>

        <h2 id="初探PHP反序列化POP链">
          <a href="#初探PHP反序列化POP链" class="heading-link"><i class="fas fa-link"></i></a><a href="#初探PHP反序列化POP链" class="headerlink" title="初探PHP反序列化POP链"></a>初探PHP反序列化POP链</h2>
      <p>POP链介绍(Property-Oriented Programing)<br>POP面向属性编程,常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-OrientedPrograming）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链,最终达到攻击者邪恶的目的。<br>说的再具体一点就是 ROP 是通过栈溢出实现控制指令的执行流程，而我们的反序列化是通过控制对象的属性从而实现控制程序的执行流程，进而达成利用本身无害的代码进行有害操作的目的。</p>

        <h2 id="寻找POP链过程：">
          <a href="#寻找POP链过程：" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找POP链过程：" class="headerlink" title="寻找POP链过程："></a>寻找POP链过程：</h2>
      <p>例子：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">error_reporting(1);</span><br><span class="line">class Read &#123;</span><br><span class="line">    public $var;</span><br><span class="line">    public function file_get($value) &#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        return $text;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $content = $this-&gt;file_get($this-&gt;var);</span><br><span class="line">        echo $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Show &#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;) &#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo $this-&gt;source.&#x27; Welcome&#x27;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString() &#123;</span><br><span class="line">        return $this-&gt;str[&#x27;str&#x27;]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function _show() &#123;</span><br><span class="line">        if(preg_match(&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;,$this-&gt;source)) &#123;</span><br><span class="line">            die(&#x27;hacker&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            highlight_file($this-&gt;source); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __wakeup() &#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Test &#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __get($key) &#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if(isset($_GET[&#x27;hello&#x27;])) &#123;</span><br><span class="line">    unserialize($_GET[&#x27;hello&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $show = new Show(&#x27;pop3.php&#x27;);</span><br><span class="line">    $show-&gt;_show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>1.首先找到unserlialize(),发现里面参数由GET方式提交且参数可控<br>2.接着寻找可以利用的魔术方法，一般实在__wakeup或者在__destruct;这里在Show类中发现有__wakeup()；<br>3.在__wakeup()里面使用per_match()函数进行一个正则匹配；当我们传进去的参数是对象时便会触发__toString()魔术方法；<br>4.在__toString()的魔术魔法中试图获取属性$str中的key为str的值，如果我们传进去的$str[‘str’]是一个类对象不可以访问的属性时，就能触发__get()的魔术方法；<br>5.接着寻找有魔法方法__get()的类，发现Test类里面有这个魔术方法。<br>6.Test类里面的__get()方法对参数$p作为函数名字进行调用，如果这时候的$p是一个类对象的话，就会触发__invoke()魔法方法；<br>7.寻找存在魔法方法__invoke()的类，发现Read类里面有这个魔术方法<br>8.Read类里面的__invoke()方法会读取参数$var里面的内容并输出<br>此时的POP链：<br>hello -&gt; wakeup -&gt; Show.show -&gt; Show.toString -&gt; (不存在属性)Test.get() -&gt; Read.invoke<br>我自己的理解：遇到POP链的题，我们首先要摸清楚链尾是什么(这个链尾就是可以帮助我们获取flag的一个函数)<br>当我们摸清链尾之后，要知道链尾的参数是什么，从何而来；当我们知道链尾的参数从何而来，要被赋与什么值后，我们就可以摸到链尾的上一步是什么，然后逐层摸索，摸到链首。先把整条POP链摸清楚，我们才好进行组装payload。下面是一道NSSCTF里面的POP链题。就拿它练练手吧！</p>

        <h2 id="SWPUCTF-2021-新生赛-pop">
          <a href="#SWPUCTF-2021-新生赛-pop" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2021-新生赛-pop" class="headerlink" title="[SWPUCTF 2021 新生赛]pop"></a>[SWPUCTF 2021 新生赛]pop</h2>
      <p><img src="/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/23.png"><br>拿到源码后，大致看一眼整体后，主要我们最终要将w44m类里面的Getflag调用出来，然后修改admin&#x3D;w44m和passwd&#x3D;08067就可以调用include包含flag.php了。知道了可以利用的点，我们就可以往上推，把目光先聚集在类w33m，w33m类里面有一个魔术方法__toString()还有两个属性w00m和w22m。<br>1.toString主要是在当类被当成字符串使用echo或者print等输出函数输出时，会被调用源码中，toString触发后，会执行<br>$this-&gt;w00m-&gt;{$this-&gt;w22m}();<br>这一串代码，针对如何调用w44m的Getflag函数，到这里就有答案了，可以将w00m设为new w44m去实例化w44m，如何再把w22m设为Getflag实现调用到这个类函数，但是怎么触发toString又是一个问题，继续往上跟进审计w22m类。<br>2.调用w22m类之后，会直接调用魔术方法destruct函数是用于当类最后执行的，当类里面的东西执行完成后，就会调用destruct对类输出最后的信息，随即类就销毁。<br>3.可以看到w22m类里面有一个属性w00m，然后destruct中使用了<br>echo $this-&gt;w00m，在上面说到了如果使用了输出函数去输出一个类实例的话，就会调用类里面的toString。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$a = new w22m();是把类给了a</span><br><span class="line"></span><br><span class="line">然后$a-&gt;w00m = new w33m();因为w22m中woom是其中的可控对象 ——tostring操作就是</span><br><span class="line"></span><br><span class="line">$a-&gt;w00m-&gt;w00m=new w44m(); w33m中woom也是其中可控对象</span><br><span class="line"></span><br><span class="line">$a-&gt;w00m-&gt;w22m=&#x27;Getflag&#x27;;</span><br><span class="line"></span><br><span class="line">w00m是w33m对象，w22m是getflag</span><br></pre></td></tr></table></div></figure>
<p>到了这里，整道题目的思路以及很清晰了，先使用w22m的echo函数去输出w33m类，然后w33m的类调用toString里面的$this-&gt;w00m-&gt;{$this-&gt;w22m}();，将w00m赋值为w44m，将w22m赋值为Getflag，再将w44m的admin和passwd赋值为题目给出的数，从而读取flag。<br>POP链：<br>w22m(destruct)-&gt;w33m(toString)-&gt;w44m(Getflag)<br>个人理解：处理这种POP链最重要的是了解每个魔术方法的触发条件和理清一条POP链中的每个节点。<br>O:4:”w22m”:1:{s:4:”w00m”;O:4:”w33m”:2:{s:4:”w00m”;O:4:”w44m”:2:{s:11:”w44madmin”;s:4:”w44m”;s:9:”*passwd”;s:5:”08067”;}s:4:”w22m”;s:7:”Getflag”;}}</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:对象名的长度:&quot;对象名&quot;:对象属性个数:&#123;s:属性名的长度:&quot;属性名&quot;;s:属性值的长度:&quot;属性值&quot;;&#125;</span><br></pre></td></tr></table></div></figure>
<p>(对这个POP链的payload还是很异或，因为我还没有掌握其中的构造原理；希望接下来的学习可以多接触，多了解，多学习)</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="https://hyggevv.github.io">hey</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://hyggevv.github.io/2022/12/19/%E5%88%9D%E6%8E%A2%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/12/21/DVWA/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">DVWA</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/12/18/buu1/"><span class="paginator-prev__text">Buu学习笔记1</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">
          序列化：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">
          反序列化：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">
          相关的魔术方法:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%B1%9E%E6%80%A7%E9%87%8D%E8%BD%BD"><span class="toc-number">4.</span> <span class="toc-text">
          4.属性重载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.</span> <span class="toc-text">
          反序列化漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">
          魔法方法的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">
          魔法方法的简单利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">
          攻击流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-PHP"><span class="toc-number">9.</span> <span class="toc-text">
          [极客大挑战 2019]PHP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SWPUCTF-2021-%E6%96%B0%E7%94%9F%E8%B5%9B-ez-unserialize"><span class="toc-number">10.</span> <span class="toc-text">
          [SWPUCTF 2021 新生赛]ez_unserialize</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%8E%A2PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96POP%E9%93%BE"><span class="toc-number">11.</span> <span class="toc-text">
          初探PHP反序列化POP链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BB%E6%89%BEPOP%E9%93%BE%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">12.</span> <span class="toc-text">
          寻找POP链过程：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SWPUCTF-2021-%E6%96%B0%E7%94%9F%E8%B5%9B-pop"><span class="toc-number">13.</span> <span class="toc-text">
          [SWPUCTF 2021 新生赛]pop</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/usually.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">hey</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">110</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>hey</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.2</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.7.0</span></div><div class="busuanzi"><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">Views</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.7.0"></script><script src="/js/stun-boot.js?v=2.7.0"></script><script src="/js/scroll.js?v=2.7.0"></script><script src="/js/header.js?v=2.7.0"></script><script src="/js/sidebar.js?v=2.7.0"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":180,"height":300},"mobile":{"show":true},"log":false});</script></body></html>